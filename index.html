<!DOCTYPE html>





<style>
  #authBar { position: fixed; left: 1rem; bottom: 1rem; z-index: 2147483000; background: #ffffff; border-radius: 12px; box-shadow: 0 8px 24px rgba(2,6,23,.08); padding: 0.6rem 0.8rem; display:flex; gap:0.6rem; align-items:center; font-size:14px; }
  #authBar .btn { padding: .45rem .7rem; border-radius: .6rem; cursor:pointer; border:1px solid #e6e6e6; background:#f8faf8; }
  #authBar .small{font-size:13px}
  #authBar .btn.primary{background:#0ea5e9; color:#fff; border:0}
  #adminPanel { position: fixed; right: 1rem; bottom: 1rem; z-index: 2147483000; width: 380px; max-width: calc(100% - 2rem); background: #fff; border-radius: 12px; box-shadow: 0 10px 30px rgba(2,6,23,.08); padding: 1rem; display:none; font-size:14px; }
  #adminPanel h4{margin:0 0 .5rem 0}
  #adminPanel .btn { padding: .45rem .7rem; border-radius: .6rem; cursor:pointer; border:1px solid #e6e6e6; background:#f8faf8; }
  #adminPanel .btn.primary{background:#0ea5e9; color:#fff; border:0}
  #adminPanel .small{font-size:13px}
  #adminPanel input{ width:100%; padding:.5rem .6rem; border-radius:.5rem; border:1px solid #eee; }
  .section-edit-btn{position: absolute; left:12px; top:12px; z-index: 2147482000; padding:6px 8px; border-radius:8px; font-size:13px; border:1px solid rgba(0,0,0,.06); background:#fff}
  #loginBackdrop{position:fixed; inset:0; background:rgba(2,6,23,.5); display:none; z-index:2147483600;}
  #loginModal{position:fixed; inset:0; display:none; z-index:2147483601; place-items:center; font-family:inherit;}
  #loginCard{width:min(420px, 92vw); background:#fff; border-radius:16px; box-shadow:0 25px 60px rgba(2,6,23,.25); padding:22px;}
  #loginCard h3{margin:0 0 4px 0; font-size:20px}
  #loginCard p.small{margin:.25rem 0 1rem 0; color:#475569; font-size:13px}
  .input{width:100%; padding:.7rem .85rem; border-radius:10px; border:1px solid #e5e7eb; outline:none}
  .row{display:flex; gap:.6rem}
  .btn{padding:.6rem .9rem; border-radius:10px; border:1px solid #e5e7eb; background:#f8fafc; cursor:pointer}
  .btn.primary{background:#0ea5e9; color:#fff; border-color:#0ea5e9}
  .btn.ghost{background:#fff}
  .grid{display:grid; gap:.6rem}
  .foot{display:flex; justify-content:space-between; align-items:center; margin-top:.8rem}
  #loginError{display:none; color:#dc2626; font-size:13px; background:#fef2f2; border:1px solid #fecaca; padding:.5rem .6rem; border-radius:8px}
</style>

<div id="authBar" aria-hidden="false" style="display: flex;">
  <div id="authUserName" class="small"></div>
  <button id="openAdminBtn" class="btn small" style="display:none">لوحة المدير</button>
  <button id="loginBtn" class="btn small" style="display: inline-flex;" fdprocessedid="qptz5p">تسجيل دخول</button>
  <button id="logoutBtn" class="btn small" style="display:none">تسجيل خروج</button>
</div>

<div id="loginBackdrop" style="display: none;"></div>
<div id="loginModal" style="display: none;">
  <div id="loginCard" role="dialog" aria-modal="true" aria-labelledby="loginTitle">
    <h3 id="loginTitle">تسجيل الدخول</h3>
    <p class="small">أدخل بريدك وكلمة المرور. إن لم يكن لديك حساب يمكنك إنشاؤه مباشرة.</p>
    <div id="loginError" style="display: none;"></div>
    <div class="grid" style="margin-top:.4rem">
      <label class="grid">
        <span class="small">البريد الإلكتروني</span>
        <input id="loginEmail" type="email" class="input" placeholder="you@example.com" autocomplete="username" required="">
      </label>
      <label class="grid">
        <span class="small">كلمة المرور</span>
        <input id="loginPass" type="password" class="input" placeholder="••••••••" autocomplete="current-password" required="">
      </label>
    </div>
    <div class="foot">
      <div class="row">
        <button id="doLogin" class="btn primary">دخول</button>
        <button id="doRegister" class="btn">إنشاء حساب</button>
      </div>
      <button id="closeLogin" class="btn ghost">إغلاق</button>
    </div>
  </div>
</div>

<div id="adminPanel" aria-hidden="true">
  <h4>لوحة الإدارة — الصلاحيات</h4>
  <div class="small" style="margin-bottom:.6rem">دورك الحالي: <span id="currentRole">—</span></div>
  <label class="small">أضف/حرّر حساب لإعطائه صلاحيات (البريد الإلكتروني)</label>
  <div style="display:flex; gap:.5rem; margin:.4rem 0 0 0">
    <input id="manageEmail" placeholder="user@example.com">
    <button id="grantBtn" class="btn primary small">حفظ الصلاحيات</button>
  </div>
  <div style="margin-top:.6rem" class="small">
    <div><b>الأقسام المتاحة للتعديل:</b></div>
    <div id="sectionsCheckboxes" style="display:flex; flex-wrap:wrap; gap:.4rem; margin-top:.4rem"><label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px; border: 1px solid rgb(240, 240, 240); border-radius: 8px;"><input type="checkbox" id="cb_hero" data-section="hero"> <span class="small">الرئيسية</span></label><label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px; border: 1px solid rgb(240, 240, 240); border-radius: 8px;"><input type="checkbox" id="cb_admins" data-section="admins"> <span class="small">الإداريون</span></label><label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px; border: 1px solid rgb(240, 240, 240); border-radius: 8px;"><input type="checkbox" id="cb_programs" data-section="programs"> <span class="small">البرامج</span></label><label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px; border: 1px solid rgb(240, 240, 240); border-radius: 8px;"><input type="checkbox" id="cb_teachers" data-section="teachers"> <span class="small">المعلمون</span></label><label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px; border: 1px solid rgb(240, 240, 240); border-radius: 8px;"><input type="checkbox" id="cb_honors" data-section="honors"> <span class="small">المتفوقون</span></label><label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px; border: 1px solid rgb(240, 240, 240); border-radius: 8px;"><input type="checkbox" id="cb_admissions" data-section="admissions"> <span class="small">التسجيل</span></label><label style="display: inline-flex; align-items: center; gap: 6px; padding: 6px; border: 1px solid rgb(240, 240, 240); border-radius: 8px;"><input type="checkbox" id="cb_contact" data-section="contact"> <span class="small">التواصل</span></label></div>
  </div>
  <div style="margin-top:.8rem">
    <div class="small" style="margin-bottom:.4rem"><b>قائمة الحسابات الممنوحة</b></div>
    <div id="grantedList" class="small" style="max-height:200px; overflow:auto; border-top:1px dashed #eee; padding-top:.6rem"></div>
  </div>
  <div style="display:flex; justify-content:flex-end; gap:.5rem; margin-top:.8rem">
    <button id="closeAdmin" class="btn small">إغلاق</button>
  </div>
</div>

<script>
(function(){
  // === Real Firebase Config (from your project) ===
  const firebaseConfig = {
    apiKey: "AIzaSyDsRxKbTLQYo6k3TBi41QykHr5IZth0vCQ",
    authDomain: "kalaf-new.firebaseapp.com",
    projectId: "kalaf-new",
    storageBucket: "kalaf-new.firebasestorage.app",
    messagingSenderId: "418466142777",
    appId: "1:418466142777:web:f7a6bd20947a589c6ccbe8",
    measurementId: "G-PV3TTV17M2"
  };
  if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const SECTIONS = [
    { id: 'hero', name: 'الرئيسية' },
    { id: 'admins', name: 'الإداريون' },
    { id: 'programs', name: 'البرامج' },
    { id: 'teachers', name: 'المعلمون' },
    { id: 'honors', name: 'المتفوقون' },
    { id: 'admissions', name: 'التسجيل' },
    { id: 'contact', name: 'التواصل' },
  ];

  const authBar = document.getElementById('authBar');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authUserName = document.getElementById('authUserName');
  const openAdminBtn = document.getElementById('openAdminBtn');
  const adminPanel = document.getElementById('adminPanel');
  const closeAdmin = document.getElementById('closeAdmin');
  const manageEmail = document.getElementById('manageEmail');
  const grantBtn = document.getElementById('grantBtn');
  const sectionsCheckboxes = document.getElementById('sectionsCheckboxes');
  const grantedList = document.getElementById('grantedList');
  const currentRoleEl = document.getElementById('currentRole');

  function renderSectionCheckboxes(){
    sectionsCheckboxes.innerHTML = '';
    SECTIONS.forEach(s=>{
      const id = 'cb_' + s.id;
      const wrapper = document.createElement('label');
      wrapper.style.display='inline-flex';
      wrapper.style.alignItems='center';
      wrapper.style.gap='6px';
      wrapper.style.padding='6px';
      wrapper.style.border='1px solid #f0f0f0';
      wrapper.style.borderRadius='8px';
      wrapper.innerHTML = `<input type="checkbox" id="${id}" data-section="${s.id}"> <span class="small">${s.name}</span>`;
      sectionsCheckboxes.appendChild(wrapper);
    });
  }
  renderSectionCheckboxes();

  // === Login Modal logic ===
  const loginBackdrop = document.getElementById('loginBackdrop');
  const loginModal = document.getElementById('loginModal');
  const loginEmail = document.getElementById('loginEmail');
  const loginPass = document.getElementById('loginPass');
  const doLogin = document.getElementById('doLogin');
  const doRegister = document.getElementById('doRegister');
  const closeLogin = document.getElementById('closeLogin');
  const loginError = document.getElementById('loginError');

  function openLogin(){ loginBackdrop.style.display='block'; loginModal.style.display='grid'; setTimeout(()=>loginEmail.focus(),50); }
  function closeLoginModal(){ loginBackdrop.style.display='none'; loginModal.style.display='none'; loginError.style.display='none'; loginError.textContent=''; loginPass.value=''; }
  function showErr(msg){ loginError.textContent = msg; loginError.style.display='block'; }

  loginBtn.addEventListener('click', openLogin);
  closeLogin.addEventListener('click', closeLoginModal);
  loginBackdrop.addEventListener('click', closeLoginModal);

  doLogin.addEventListener('click', async ()=>{
    const email = (loginEmail.value||'').trim();
    const pass = (loginPass.value||'');
    if(!email || !pass){ showErr('الرجاء إدخال البريد وكلمة المرور'); return; }
    try{ await auth.signInWithEmailAndPassword(email, pass); closeLoginModal(); alert('تم تسجيل الدخول'); }
    catch(err){ showErr(err.message); }
  });

  doRegister.addEventListener('click', async ()=>{
    const email = (loginEmail.value||'').trim();
    const pass = (loginPass.value||'');
    if(!email || !pass){ showErr('الرجاء إدخال البريد وكلمة المرور لإنشاء الحساب'); return; }
    try{ await auth.createUserWithEmailAndPassword(email, pass); closeLoginModal(); alert('تم إنشاء الحساب وتسجيل الدخول. اطلب من المدير منحك صلاحيات إذا لزم.'); }
    catch(err){ showErr(err.message); }
  });

  logoutBtn.addEventListener('click', ()=> auth.signOut());

  // === Grant/Revoke roles (uses serverTimestamp) ===
  grantBtn.addEventListener('click', async ()=>{
    const email = (manageEmail.value||'').trim();
    if(!email){ alert('اكتب بريد صحيح'); return; }
    const allowed = Array.from(sectionsCheckboxes.querySelectorAll('input[type=checkbox]'))
                         .filter(i=>i.checked).map(i=>i.dataset.section);
    try{
      await db.collection('roles').doc(email).set({
        email, allowedSections: allowed, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge: true });
      alert('تم حفظ صلاحيات هذا الحساب.');
      loadGrantedList();
    }catch(e){ alert('خطأ: '+e.message); }
  });

  async function loadGrantedList(){
    grantedList.innerHTML = 'جارٍ التحميل...';
    const snap = await db.collection('roles').orderBy('updatedAt','desc').limit(20).get();
    if(snap.empty){ grantedList.innerHTML = '<div class="small">لا توجد حسابات ممنوحة.</div>'; return; }
    grantedList.innerHTML = '';
    snap.forEach(d=>{
      const data = d.data();
      const div = document.createElement('div');
      div.style.padding = '.4rem 0'; div.style.borderBottom='1px dashed #f0f0f0';
      div.innerHTML = `<div style="display:flex; justify-content:space-between; gap:.5rem; align-items:center">
        <div><b>${data.email}</b><div class="small">صلاحيات: ${ (data.allowedSections||[]).join(', ') || 'لا شيء'}</div></div>
        <div style="display:flex; gap:.4rem">
          <button class="btn small" data-email="${data.email}" data-action="revoke">سحب</button>
        </div>
      </div>`;
      grantedList.appendChild(div);
    });
    Array.from(grantedList.querySelectorAll('[data-action="revoke"]')).forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const email = btn.dataset.email;
        if(!confirm('سحب الصلاحيات عن '+email+' ؟')) return;
        await db.collection('roles').doc(email).delete();
        loadGrantedList();
      });
    });
  }

  function showEditButtonsFor(allowedSections, userEmail){
    Array.from(document.querySelectorAll('.section-edit-btn')).forEach(b=>b.remove());
    allowedSections.forEach(secId=>{
      const el = document.getElementById(secId);
      if(!el) return;
      const btn = document.createElement('button');
      btn.className = 'section-edit-btn small';
      btn.textContent = 'تعديل';
      btn.title = 'تعديل قسم ' + secId;
      btn.addEventListener('click', ()=> openSectionEditor(secId, userEmail));
      if (getComputedStyle(el).position === 'static') { el.style.position='relative'; }
      el.appendChild(btn);
    });
  }

  async function openSectionEditor(sectionId, userEmail){
    const el = document.getElementById(sectionId);
    if(!el) return alert('القسم غير موجود.');
    const current = el.innerHTML;
    const newHtml = prompt('تحرير HTML لقسم: '+sectionId, current);
    if(newHtml === null) return;
    const roleDoc = await db.collection('roles').doc(userEmail).get();
    const role = roleDoc.exists ? roleDoc.data() : null;
    const allowed = role && (role.role==='manager' || (role.allowedSections||[]).includes(sectionId));
    if(!allowed){ alert('لا تملك صلاحية تعديل هذا القسم.'); return; }
    await db.collection('edits').add({
      sectionId, editor: userEmail, html: newHtml,
      ts: firebase.firestore.FieldValue.serverTimestamp()
    });
    el.innerHTML = newHtml;
    alert('تم حفظ التعديل وتحديث الصفحة.');
  }

  auth.onAuthStateChanged(async user=>{
    authBar.style.display='flex';
    if(user){
      authUserName.textContent = user.email;
      loginBtn.style.display = 'none';
      logoutBtn.style.display = 'inline-flex';
      const doc = await db.collection('roles').doc(user.email).get();
      const data = doc.exists ? doc.data() : null;
      currentRoleEl.textContent = data && data.role ? data.role : 'عادي';
      if(data && data.role === 'manager'){
        openAdminBtn.style.display = 'inline-flex';
        showEditButtonsFor(SECTIONS.map(s=>s.id), user.email);
      }else{
        openAdminBtn.style.display = 'none';
        showEditButtonsFor((data && data.allowedSections) || [], user.email);
      }
    }else{
      authUserName.textContent = '';
      loginBtn.style.display = 'inline-flex';
      logoutBtn.style.display = 'none';
      openAdminBtn.style.display = 'none';
      currentRoleEl.textContent = '—';
      showEditButtonsFor([], null);
    }
  });
})();
</script>


<span id="PING_IFRAME_FORM_DETECTION" style="display: none;"></span>
  
  
  
  

  <script>
  (function(){
    const firebaseConfig = {
      apiKey: "AIzaSyDsRxKbTLQYo6k3TBi41QykHr5IZth0vCQ",
      authDomain: "kalaf-new.firebaseapp.com",
      projectId: "kalaf-new",
      storageBucket: "kalaf-new.firebasestorage.app",
      messagingSenderId: "418466142777",
      appId: "1:418466142777:web:f7a6bd20947a589c6ccbe8",
      measurementId: "G-PV3TTV17M2"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // الأقسام (تأكد أن عناصر الصفحة لها نفس الـ id)
    const SECTIONS = [
      { id: 'hero', name: 'الرئيسية' },
      { id: 'admins', name: 'الإداريون' },
      { id: 'programs', name: 'البرامج' },
      { id: 'teachers', name: 'المعلمون' },
      { id: 'honors', name: 'المتفوقون' },
      { id: 'admissions', name: 'التسجيل' },
      { id: 'contact', name: 'التواصل' },
    ];

    // عناصر الواجهة
    const authBar = document.getElementById('authBar');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const authUserName = document.getElementById('authUserName');
    const openAdminBtn = document.getElementById('openAdminBtn');
    const adminPanel = document.getElementById('adminPanel');
    const closeAdmin = document.getElementById('closeAdmin');
    const manageEmail = document.getElementById('manageEmail');
    const grantBtn = document.getElementById('grantBtn');
    const sectionsCheckboxes = document.getElementById('sectionsCheckboxes');
    const grantedList = document.getElementById('grantedList');
    const currentRoleEl = document.getElementById('currentRole');

    function renderSectionCheckboxes(){
      sectionsCheckboxes.innerHTML = '';
      SECTIONS.forEach(s=>{
        const id = 'cb_' + s.id;
        const wrap = document.createElement('label');
        wrap.style.display = 'inline-flex';
        wrap.style.alignItems = 'center';
        wrap.style.gap = '6px';
        wrap.style.padding = '6px';
        wrap.style.border = '1px solid #f0f0f0';
        wrap.style.borderRadius = '8px';
        wrap.innerHTML = `<input type="checkbox" id="${id}" data-section="${s.id}"> <span class="small">${s.name}</span>`;
        sectionsCheckboxes.appendChild(wrap);
      });
    }
    renderSectionCheckboxes();

    // نافذة الدخول
    const loginBackdrop = document.getElementById('loginBackdrop');
    const loginModal = document.getElementById('loginModal');
    const loginEmail = document.getElementById('loginEmail');
    const loginPass = document.getElementById('loginPass');
    const doLogin = document.getElementById('doLogin');
    const doRegister = document.getElementById('doRegister');
    const closeLogin = document.getElementById('closeLogin');
    const loginError = document.getElementById('loginError');

    function openLogin(){ loginBackdrop.style.display='block'; loginModal.style.display='grid'; setTimeout(()=>loginEmail.focus(),50); }
    function closeLoginModal(){ loginBackdrop.style.display='none'; loginModal.style.display='none'; loginError.style.display='none'; loginError.textContent=''; loginPass.value=''; }
    function showErr(msg){ loginError.textContent = msg; loginError.style.display='block'; }

    loginBtn.addEventListener('click', openLogin);
    closeLogin.addEventListener('click', closeLoginModal);
    loginBackdrop.addEventListener('click', closeLoginModal);

    doLogin.addEventListener('click', async ()=>{
      const email = (loginEmail.value||'').trim();
      const pass = (loginPass.value||'');
      if(!email || !pass){ showErr('الرجاء إدخال البريد وكلمة المرور'); return; }
      try{ await auth.signInWithEmailAndPassword(email, pass); closeLoginModal(); }
      catch(err){ showErr(err.message); }
    });

    doRegister.addEventListener('click', async ()=>{
      const email = (loginEmail.value||'').trim();
      const pass = (loginPass.value||'');
      if(!email || !pass){ showErr('الرجاء إدخال البريد وكلمة المرور لإنشاء الحساب'); return; }
      try{ await auth.createUserWithEmailAndPassword(email, pass); closeLoginModal(); }
      catch(err){ showErr(err.message); }
    });

    logoutBtn.addEventListener('click', ()=> auth.signOut());
    openAdminBtn.addEventListener('click', ()=> adminPanel.style.display='block');
    closeAdmin.addEventListener('click', ()=> adminPanel.style.display='none');

    // منح/سحب الصلاحيات
    grantBtn.addEventListener('click', async ()=>{
      const email = (manageEmail.value||'').trim().toLowerCase();
      if(!email){ alert('اكتب بريد صحيح'); return; }
      const allowed = Array.from(sectionsCheckboxes.querySelectorAll('input[type=checkbox]'))
                           .filter(i=>i.checked).map(i=>i.dataset.section);
      try{
        await db.collection('roles').doc(email).set({
          email, allowedSections: allowed, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        alert('تم حفظ صلاحيات هذا الحساب.');
        loadGrantedList();
      }catch(e){ alert('خطأ: '+e.message); }
    });

    async function loadGrantedList(){
      grantedList.innerHTML = 'جارٍ التحميل...';
      const snap = await db.collection('roles').orderBy('updatedAt','desc').limit(50).get();
      if(snap.empty){ grantedList.innerHTML = '<div class="small">لا توجد حسابات ممنوحة.</div>'; return; }
      grantedList.innerHTML = '';
      snap.forEach(d=>{
        const data = d.data();
        const div = document.createElement('div');
        div.style.padding = '.4rem 0'; div.style.borderBottom='1px dashed #f0f0f0';
        div.innerHTML = `<div style="display:flex; justify-content:space-between; gap:.5rem; align-items:center">
          <div><b>${data.email||d.id}</b><div class="small">صلاحيات: ${ (data.allowedSections||[]).join(', ') || 'لا شيء'}</div></div>
          <div style="display:flex; gap:.4rem">
            <button class="btn small" data-email="${d.id}" data-action="revoke" style="padding:.3rem .5rem; border:1px solid #eee">سحب</button>
          </div>
        </div>`;
        grantedList.appendChild(div);
      });
      Array.from(grantedList.querySelectorAll('[data-action="revoke"]')).forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const email = btn.dataset.email;
          if(!confirm('سحب الصلاحيات عن '+email+' ؟')) return;
          await db.collection('roles').doc(email).delete();
          loadGrantedList();
        });
      });
    }

    function showEditButtonsFor(allowedSections, userEmail){
      Array.from(document.querySelectorAll('.section-edit-btn')).forEach(b=>b.remove());
      allowedSections.forEach(secId=>{
        const el = document.getElementById(secId);
        if(!el) return;
        const btn = document.createElement('button');
        btn.className = 'section-edit-btn small';
        btn.textContent = 'تعديل';
        btn.title = 'تعديل قسم ' + secId;
        btn.style.position = 'absolute';
        btn.style.left = '12px';
        btn.style.top = '12px';
        btn.style.zIndex = '2147482000';
        btn.style.padding = '6px 8px';
        btn.style.borderRadius = '8px';
        btn.style.fontSize = '13px';
        btn.style.border = '1px solid rgba(0,0,0,.06)';
        btn.style.background = '#fff';
        btn.addEventListener('click', ()=> openSectionEditor(secId, userEmail));
        if (getComputedStyle(el).position === 'static') { el.style.position='relative'; }
        el.appendChild(btn);
      });
    }

    async function openSectionEditor(sectionId, userEmail){
      const el = document.getElementById(sectionId);
      if(!el) return alert('القسم غير موجود.');
      const current = el.innerHTML;
      const newHtml = prompt('تحرير HTML لقسم: '+sectionId, current);
      if(newHtml === null) return;
      const roleDoc = await db.collection('roles').doc(userEmail.toLowerCase()).get();
      const role = roleDoc.exists ? roleDoc.data() : null;
      const allowed = role && (role.role==='manager' || (role.allowedSections||[]).includes(sectionId));
      if(!allowed){ alert('لا تملك صلاحية تعديل هذا القسم.'); return; }
      await db.collection('edits').add({
        sectionId, editor: userEmail, html: newHtml,
        ts: firebase.firestore.FieldValue.serverTimestamp()
      });
      el.innerHTML = newHtml;
      alert('تم حفظ التعديل وتحديث الصفحة.');
    }

    async function applyLatestEdits(){
      for (const s of SECTIONS){
        try{
          const snap = await db.collection('edits')
            .where('sectionId','==',s.id).get();
          if(!snap.empty){
            let latest = null;
            snap.forEach(d=>{ const x=d.data(); if(!latest || (x.ts && latest.ts && x.ts.toMillis? x.ts.toMillis()>latest.ts.toMillis(): true)) latest = x; });
            const data = latest || snap.docs[0].data();
            const el = document.getElementById(s.id);
            if(el){ el.innerHTML = data.html; }
          }
        }catch(e){ console.warn('تعذر تحميل تعديل للقسم', s.id, e); }
      }
    }

    auth.onAuthStateChanged(async user=>{
      if(user){
        authUserName.textContent = user.email;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-flex';
        const doc = await db.collection('roles').doc(user.email.toLowerCase()).get();
        const data = doc.exists ? doc.data() : null;
        currentRoleEl.textContent = data && data.role ? data.role : 'عادي';
        if(data && data.role === 'manager'){
          openAdminBtn.style.display = 'inline-flex';
          adminPanel.style.display = 'none';
          showEditButtonsFor(SECTIONS.map(s=>s.id), user.email);
          loadGrantedList();
        }else{
          openAdminBtn.style.display = 'none';
          adminPanel.style.display = 'none';
          showEditButtonsFor((data && data.allowedSections) || [], user.email);
        }
      }else{
        authUserName.textContent = '';
        loginBtn.style.display = 'inline-flex';
        logoutBtn.style.display = 'none';
        openAdminBtn.style.display = 'none';
        adminPanel.style.display = 'none';
        currentRoleEl.textContent = '—';
        showEditButtonsFor([], null);
      }
    });

    applyLatestEdits();
  })();
  </script>


<!-- Fallback to guarantee login button works even if other scripts/CSS conflict -->
<script>
(function(){
  function __ensureLoginWires(){
    var btn = document.getElementById('loginBtn');
    var backdrop = document.getElementById('loginBackdrop');
    var modal = document.getElementById('loginModal');
    if(!btn || !backdrop || !modal) return;
    // bring to top & clickable
    btn.style.position = 'relative';
    btn.style.zIndex = '2147483647';
    btn.style.pointerEvents = 'auto';
    // expose opener globally
    if (typeof window.__openLogin !== 'function') {
      window.__openLogin = function(){
        try {
          backdrop.style.display='block';
          modal.style.display='grid';
          var email = document.getElementById('loginEmail');
          if(email) setTimeout(function(){ email.focus(); }, 50);
        }catch(e){ console.warn(e); }
      };
    }
    // attach handler (avoid duplicate)
    btn.onclick = function(evt){
      evt.preventDefault();
      if (window.__openLogin) window.__openLogin();
      return false;
    };
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', __ensureLoginWires);
  } else {
    __ensureLoginWires();
  }
})();
</script>


<!-- Single source of truth: Firebase ESM imports -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAuth } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import { getFirestore } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDsRxKbTLQYo6k3TBi41QykHr5IZth0vCQ",
    authDomain: "kalaf-new.firebaseapp.com",
    projectId: "kalaf-new",
    storageBucket: "kalaf-new.firebasestorage.app",
    messagingSenderId: "418466142777",
    appId: "1:418466142777:web:f7a6bd20947a589c6ccbe8",
    measurementId: "G-PV3TTV17M2"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  // expose for other inline scripts if needed
  window.firebaseApp = app;
  window.auth = auth;
  window.db = db;
</script>

<!-- Ultra fallback to guarantee login opener -->
<script>
(function(){
  function openLoginModal(){
    try{
      var backdrop = document.getElementById('loginBackdrop');
      var modal = document.getElementById('loginModal');
      if(!backdrop || !modal){ return; }
      backdrop.style.display='block';
      modal.style.display='grid';
      var email = document.getElementById('loginEmail');
      if(email){ setTimeout(function(){ email.focus(); }, 30); }
    }catch(e){ console.warn(e); }
  }
  window.__openLogin = openLoginModal;

  function wireBtn(){
    var btn = document.getElementById('loginBtn');
    if(!btn) return;
    btn.onclick = function(e){ e.preventDefault(); openLoginModal(); return false; };
    btn.style.zIndex = '2147483647';
    btn.style.pointerEvents = 'auto';
    btn.setAttribute('data-wired','1');
  }
  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', wireBtn);
  } else {
    wireBtn();
  }
  setInterval(function(){
    var btn=document.getElementById('loginBtn');
    if(btn && !btn.getAttribute('data-wired')) wireBtn();
  }, 1000);
})();
</script>

</body>
</html>
